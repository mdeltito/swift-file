#!/usr/bin/env ruby
require "optparse"
require "highline/import"
require "swift_file"

options = {}

optparse = OptionParser.new do|opts|
  opts.banner = "Usage: swift_file [options] file1 file2 ..."

  options[:group] = nil
  opts.on( '-g', '--group GROUP', 'Add this file to a group' ) do |group|
    options[:group] = group
  end

  options[:password] = nil
  opts.on( '-p[PASS]', 'Supply a password to encrypt the file. This password is
    transferred securely and is never stored. It will be required to retrieve
    the file, and you will need to (securely) communicate thie password with the recipient.' ) do |pass|
    options[:password] = pass
  end
end

# User has (correctly) supplied the -p flag without the password
password_supplied = ARGV.include?('-p')

begin
  optparse.parse!
rescue OptionParser::InvalidOption, OptionParser::MissingArgument
  puts 'ERROR: ' + $!.to_s
end

if options[:password] == nil && password_supplied
  # FIXME: highline is not behaving on my installation, and
  #   disabling echo causes an infinte loop of errors
  options[:password] = ask("Enter a password: ") # { |q| q.echo = false }
end

begin
  ARGV.each do |filepath|
    f = File.new(filepath)
    sf = SwiftFile::SwiftUpload.new({
      :file => f,
      :group => options[:group],
      :password => options[:password]
    })

    sf.transfer
    puts sf.url
  end
rescue => e
  puts "ERROR: #{e}"
end
